<!DOCTYPE html>
  <head>
    <link rel='stylesheet' href='style.css'>
    <!-- Load TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.12.4"> </script>
    <!--Load the AJAX API-->
    <script type="text/javascript" src="lib/dsp.js"></script>
    <script type="text/javascript" src="lib/pyodide.js"></script>
    <script type="text/javascript" src="lib/wavdecoder.js"></script>
    <script type="text/javascript" src="lib/Wav.js"></script>
    <script type="text/javascript" src="lib/AudioClassification.js"></script>
    <script type="text/javascript" src="lib/AudioGenerator.js"></script>
    <script type="text/javascript" src="lib/Graph.js"></script>
    <script type="text/javascript" src="lib/NNetworks.js"></script>
  </head>
  
  <body>
    <h1>Generate Spectrogram or MFCC features from Audio files</h1>
    <p>Select the audio</p>
    <button id="opt1"><span xid='audioFile1'></span></button>
    <button id="opt2"><span xid='audioFile2'></span></button>
    <p>Current audio file: <span xid='audioFile'></span></p>
    <div class='loading'><p>Loading the Python language.<small> Please wait...</small></p></div>
    <div id="vis" class="spectrogram"></div>
    <button id="spec_btn">Generate Spectrogram</button>
    <button id="mfcc_btn">Generate MFCC [not implemented yet]</button>
    <p style="width: 100%; white-space: pre-wrap; font-size: 24px; font-weight: 700;" id="spec_result_btn"></p>
    <p style="width: 100%; white-space: pre-wrap; font-size: 24px; font-weight: 700;" id="mfcc_result_btn"></p>
    <script type="text/javascript" src="lib/ui.js"></script>
    <script>
      const TEXT2MEL_MODEL_URL = 'data/dctts_text2mel_model/tensorflowjs_model.pb';
      const TEXT2MEL_WEIGHTS_URL = 'data/dctts_text2mel_model/weights_manifest.json';
      const SSRN_MODEL_URL = 'data/dctts_ssrn_model/tensorflowjs_model.pb';
      const SSRN_WEIGHTS_URL = 'data/dctts_ssrn_model/weights_manifest.json';
      const TACOTRON_MODEL_URL = 'data/tacotron_model/tensorflowjs_model.pb';
      const TACOTRON_WEIGHTS_URL = 'data/tacotron_model/weights_manifest.json';
      async function loadModel() {
        try {
          // const t2mModel = await tf.loadFrozenModel(TEXT2MEL_MODEL_URL, TEXT2MEL_WEIGHTS_URL);
          // console.log(t2mModel);
          // const ssrnModel = await tf.loadFrozenModel(SSRN_MODEL_URL, SSRN_WEIGHTS_URL);
          // console.log(ssrnModel);
          // const tacotronModel = await tf.loadFrozenModel(TACOTRON_MODEL_URL, TACOTRON_WEIGHTS_URL);
          // console.log(tacotronModel);
        }catch(e) {
          console.log(e);
        }
      }
      // loadModel();
      const _ui = ui();
      // load Python language
      _ui.showLoading();
      languagePluginLoader.then(() => {
        console.warn('Python initialized');
        let audioGen = new AudioGenerator(_ui);
        let specBtn = document.querySelector('#spec_btn');
        let mfccBtn = document.querySelector('#mfcc_btn');
        let specResultLabel = document.querySelector('#spec_result_btn');
        let mfccResultLabel = document.querySelector('#mfcc_result_btn');
        specBtn.onclick = function(evt) {
          let startTime = new Date().getTime();
          audioGen.spectrogramFromFile(_ui.currentAudio(), 10, 20).then((spectrogram) => {
            let now = new Date().getTime();
            let elapsedTime = (now - startTime) / 1000;
            console.log(`Success!! Generated Spectrogram in ${elapsedTime} seconds`);
            specResultLabel.textContent = `Success!! Generated Spectrogram in ${elapsedTime} seconds`;
          });
        }
        mfccBtn.onclick = function(evt) {
          // TODO mfcc extraction
          let startTime = new Date().getTime();
          audioGen.mfccFromFile(_ui.currentAudio()).then((mfcc) => {
            let now = new Date().getTime();
            let elapsedTime = (now - startTime) / 1000;
            console.log(`Success!! Generated MFCC in ${elapsedTime} seconds`);
            mfccResultLabel.textContent = `Success!! Generated MFCC in ${elapsedTime} seconds`;
          });
        }
        
      });
    </script>
  </body>
</html>